<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Viikon Ruokalista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif }
    .editable {
      min-height: 40px;
      padding: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.2s;
      white-space: pre-line;
    }
    .dark .editable {
      border-color: #374151;
      background: #1f2937;
      color: #f3f4f6;
    }
    .readonly {
      background: #f3f4f6 !important;
      cursor: not-allowed;
    }
    .dark .readonly {
      background: #374151 !important;
    }
    .loading {
      opacity: 0.6;
    }
    /* Custom select with right arrow, text centered */
    .custom-select {
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      color: #222;
      padding: 0.5rem 2.5rem 0.5rem 1rem;
      font-size: 1.05rem;
      min-width: 200px;
      margin: 0 auto;
      display: block;
      text-align: center;
      border-radius: 0;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg fill='none' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1.2em;
    }
    .custom-select:focus {
      outline: 2px solid #2563eb;
      border-color: #2563eb;
    }
    .dark .custom-select {
      background: #1f2937;
      color: #f3f4f6;
      border-color: #374151;
      background-image: url("data:image/svg+xml,%3Csvg fill='none' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    }
    option { color: #111; text-align: center; }
    .dark option { color: #fafafa; }
    .week-info {
      margin-top: 1.5rem;
      color: #2563eb;
      font-weight: 600;
      font-size: 1.08rem;
      text-align: center;
      background: #f1f8fd;
      border-radius: 0.5rem;
      padding: 0.7em 0.3em;
      letter-spacing: 0.01em;
    }
    .dark .week-info {
      background: #1f2937;
      color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">Viikon Ruokalista</h1>
        <p class="text-gray-600 dark:text-gray-400" id="currentWeekTopInfo"></p>
      </div>

      <!-- Viikkovalitsin (DROPDOWN) -->
      <div class="mb-6">
        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
          <h3 class="font-semibold mb-3 text-center">Valitse viikko:</h3>
          <div class="flex justify-center">
            <select id="weekDropdown" class="custom-select"></select>
          </div>
          <div class="week-info" id="currentWeekInfo"></div>
        </div>
      </div>

      <div class="space-y-6" id="ruokaviikko"></div>
      
      <div class="mt-8 text-center space-y-4">
        <div class="flex flex-wrap justify-center gap-3">
          <button id="paivita" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üîÑ P√§ivit√§ tiedot</button>
          <button id="kopioi" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üìã Kopioi sis√§lt√∂</button>
          <button id="tulosta" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üñ®Ô∏è Tulosta</button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          üí° Tiedot p√§ivittyv√§t automaattisesti Google Sheetsist√§.
        </p>
      </div>
    </div>
  </div>
  <script type="module">
    // ============ MUUTA N√ÑM√Ñ OMAAN K√ÑYTT√ñ√ñSI ============
    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/10bBmmXNo8YWJKgak6MT1znba_dE1Ft-eyAfM-qNjqqU/edit?gid=0#gid=0';
    const WEEK_COUNT = 20; // Kuinka monta viikkoa n√§ytet√§√§n valitsimessa
    // =====================================================

    // Tumma tila automaattisesti
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
      document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    const days = [
      { name: "Maanantai" },
      { name: "Tiistai" },
      { name: "Keskiviikko" },
      { name: "Torstai" },
      { name: "Perjantai" }
    ];
    const fields = [
      { key: "ruoka", label: "Ruoka", placeholder: "Ladataan..." },
      { key: "kuka", label: "Kuka tekee", placeholder: "Ladataan..." },
      { key: "tarvikkeet", label: "Tarvikkeet", placeholder: "Ladataan..." },
      { key: "ohjeet", label: "Ohjeet", placeholder: "Ladataan..." }
    ];

    let currentWeek = getCurrentIsoWeek();
    let spreadsheetId = null;
    let availableWeeks = [];

    function getCurrentIsoWeek() {
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const thursday = new Date(now);
      thursday.setDate(now.getDate() + 3 - ((now.getDay() + 6) % 7));
      const year = thursday.getFullYear();
      const firstThursday = new Date(year, 0, 4);
      firstThursday.setDate(firstThursday.getDate() + 3 - ((firstThursday.getDay() + 6) % 7));
      const week = 1 + Math.round(((thursday.getTime() - firstThursday.getTime()) / 86400000 - 3) / 7);
      return `${year}-V${week.toString().padStart(2, '0')}`;
    }

    function getIsoWeekRangeByYearWeek(isoYear, isoWeek) {
      const simple = new Date(isoYear, 0, 1 + (isoWeek - 1) * 7);
      const dow = simple.getDay();
      let ISOweekStart = new Date(simple);
      if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
      else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
      const monday = new Date(ISOweekStart);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return { monday, sunday };
    }

    function formatDate(dt) {
      return dt.getDate().toString().padStart(2, '0') + '.' +
        (dt.getMonth()+1).toString().padStart(2, '0') + '.' +
        dt.getFullYear();
    }

    function generateWeekList(currentIsoWeek, count) {
      const [yearStr, weekStr] = currentIsoWeek.split('-V');
      let year = parseInt(yearStr, 10);
      let week = parseInt(weekStr, 10);
      const weeks = [];
      for (let i = 0; i < count; i++) {
        const iso = `${year}-V${week.toString().padStart(2, '0')}`;
        const {monday, sunday} = getIsoWeekRangeByYearWeek(year, week);
        weeks.push({
          name: iso,
          monday,
          sunday
        });
        week++;
        if (week > 52) {
          week = 1;
          year++;
        }
      }
      return weeks;
    }

    function extractSpreadsheetId(url) {
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }

    function renderDays() {
      let html = "";
      days.forEach((day, dayIndex) => {
        html += `<div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
          <h2 class="text-2xl font-semibold mb-4">${day.name}</h2>
          <div class="grid md:grid-cols-2 gap-6">`;
        fields.slice(0,2).forEach((field) => {
          html += `<div>
            <label class="block text-sm font-medium mb-2">${field.label}</label>
            <div class="editable readonly text-base" data-day="${dayIndex}" data-field="${field.key}" data-placeholder="${field.placeholder}"></div>
          </div>`;
        });
        html += `</div>
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">${fields[2].label}</label>
            <div class="editable readonly text-base" data-day="${dayIndex}" data-field="${fields[2].key}" data-placeholder="${fields[2].placeholder}"></div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">${fields[3].label}</label>
            <div class="editable readonly text-base min-h-20" data-day="${dayIndex}" data-field="${fields[3].key}" data-placeholder="${fields[3].placeholder}"></div>
          </div>
        </div>`;
      });
      document.getElementById('ruokaviikko').innerHTML = html;
    }

    function renderWeekDropdown() {
      const dropdown = document.getElementById('weekDropdown');
      dropdown.innerHTML = '';
      availableWeeks.forEach(week => {
        const opt = document.createElement('option');
        opt.value = week.name;
        opt.textContent = week.name;
        if (week.name === currentWeek) opt.selected = true;
        dropdown.appendChild(opt);
      });
      dropdown.onchange = function() {
        selectWeek(this.value);
      };
    }

    // N√§ytet√§√§n kuluva viikko (aina oikea, ei dropdownin mukaan)
    function updateCurrentWeekTopInfo() {
      const info = document.getElementById('currentWeekTopInfo');
      const todayWeek = getCurrentIsoWeek();
      const [yearStr, weekStr] = todayWeek.split('-V');
      const {monday, sunday} = getIsoWeekRangeByYearWeek(parseInt(yearStr,10), parseInt(weekStr,10));
      info.textContent = `kuluva viikko: ${todayWeek} ${formatDate(monday)} - ${formatDate(sunday)}`;
    }

    // N√§ytet√§√§n dropdownista valitun viikon tiedot "week-info"-laatikkoon
    function updateCurrentWeekInfo() {
      const info = document.getElementById('currentWeekInfo');
      const [yearStr, weekStr] = currentWeek.split('-V');
      const {monday, sunday} = getIsoWeekRangeByYearWeek(parseInt(yearStr,10), parseInt(weekStr,10));
      info.textContent = `${currentWeek} ${formatDate(monday)} - ${formatDate(sunday)}`;
    }

    function selectWeek(weekName) {
      currentWeek = weekName;
      updateCurrentWeekInfo();
      loadData();
      localStorage.setItem('selectedWeek', weekName);
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = '';
      let inQuotes = false;
      let i = 0;
      while (i < text.length) {
        const char = text[i];
        const nextChar = text[i + 1];
        if (inQuotes) {
          if (char === '"') {
            if (nextChar === '"') {
              field += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            field += char;
          }
        } else {
          if (char === '"') {
            inQuotes = true;
          } else if (char === ',') {
            row.push(field);
            field = '';
          } else if (char === '\r' && nextChar === '\n') {
            row.push(field);
            rows.push(row);
            row = [];
            field = '';
            i++;
          } else if (char === '\n' || char === '\r') {
            row.push(field);
            rows.push(row);
            row = [];
            field = '';
          } else {
            field += char;
          }
        }
        i++;
      }
      if (field !== '' || row.length > 0) {
        row.push(field);
        rows.push(row);
      }
      return rows;
    }

    function formatLinebreaks(text) {
      if (!text) return '';
      let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return safe.replace(/\r\n|\r|\n/g, "<br>");
    }

    function updateField(dayIndex, fieldKey, value) {
      const element = document.querySelector(`[data-day="${dayIndex}"][data-field="${fieldKey}"]`);
      if (element) {
        element.innerHTML = formatLinebreaks(value || '');
      }
    }

    function populateFields(sheetData) {
      document.querySelectorAll('.editable').forEach(el => { el.innerHTML = ''; });
      sheetData.forEach((row, rowIndex) => {
        if (rowIndex === 0) return;
        const dayIndex = rowIndex - 1;
        if (dayIndex >= 5) return;
        const [_, ruoka, kuka, tarvikkeet, ohjeet] = row;
        updateField(dayIndex, 'ruoka', ruoka);
        updateField(dayIndex, 'kuka', kuka);
        updateField(dayIndex, 'tarvikkeet', tarvikkeet);
        updateField(dayIndex, 'ohjeet', ohjeet);
      });
    }

    async function loadData() {
      if (!currentWeek) return;
      const container = document.getElementById('ruokaviikko');
      container.classList.add('loading');
      try {
        const sheetName = currentWeek;
        const encodedSheetName = encodeURIComponent(sheetName);
        const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodedSheetName}`;
        const response = await fetch(csvUrl);
        if (!response.ok) throw new Error(`Viikkoa "${sheetName}" ei l√∂ydy tai dokumentti ei ole julkinen`);
        const csvData = await response.text();
        if (csvData.includes('Invalid') || csvData.includes('Error')) throw new Error(`Viikkoa "${sheetName}" ei l√∂ydy`);
        const rows = parseCSV(csvData);
        if (rows.length > 0) {
          populateFields(rows);
        } else {
          document.querySelectorAll('.editable').forEach(el => { el.innerHTML = ''; });
        }
      } catch (error) {
        document.querySelectorAll('.editable').forEach(el => { el.innerHTML = ''; });
      } finally {
        container.classList.remove('loading');
      }
    }

    document.getElementById('kopioi').onclick = function() {
      let output = `VIIKON RUOKALISTA - ${currentWeek}\n\n`;
      const dayBlocks = document.querySelectorAll('.bg-gray-50, .dark\\:bg-gray-800');
      Array.from(dayBlocks).forEach((block) => {
        const day = block.querySelector('h2').textContent;
        const [ruoka, kuka, tarvikkeet, ohjeet] = block.querySelectorAll('.editable');
        output += `${day.toUpperCase()}\nRuoka: ${ruoka.innerText.trim()}\nKuka tekee: ${kuka.innerText.trim()}\nTarvikkeet: ${tarvikkeet.innerText.trim()}\nOhjeet: ${ohjeet.innerText.trim()}\n\n`;
      });
      navigator.clipboard.writeText(output).then(() => {
        showToast('Ruokalista kopioitu leikep√∂yd√§lle!');
      });
    };

    document.getElementById('tulosta').onclick = function() { window.print(); };

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { 
        toast.style.transform = 'translateX(400px)'; 
        setTimeout(() => toast.remove(), 300); 
      }, 2000);
    }

    document.getElementById('paivita').addEventListener('click', loadData);

    function initApp() {
      spreadsheetId = extractSpreadsheetId(GOOGLE_SHEETS_URL);
      if (!spreadsheetId) {
        alert('Virheellinen Google Sheets URL');
        return;
      }
      renderDays();
      availableWeeks = generateWeekList(getCurrentIsoWeek(), WEEK_COUNT);
      const savedWeek = localStorage.getItem('selectedWeek');
      if (savedWeek && availableWeeks.some(w => w.name === savedWeek)) {
        currentWeek = savedWeek;
      } else {
        currentWeek = availableWeeks[0]?.name || getCurrentIsoWeek();
      }
      renderWeekDropdown();
      updateCurrentWeekTopInfo();
      updateCurrentWeekInfo();
      loadData();
      setInterval(loadData, 5 * 60 * 1000);
    }

    initApp();
  </script>
</body>
</html>
