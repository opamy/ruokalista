<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Viikon Ruokalista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif }
    .editable {
      min-height: 40px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.2s;
    }
    .dark .editable {
      border-color: #374151;
      background: #1f2937;
      color: #f3f4f6;
    }
    .editable:focus {
      outline: none;
      border-color: #5D5CDE;
      background: white;
      box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
    }
    .dark .editable:focus {
      background: #111827;
    }
    .editable:empty:before {
      content: attr(data-placeholder);
      color: #9ca3af;
    }
    .dark .editable:empty:before {
      color: #6b7280;
    }
    .readonly {
      background: #f3f4f6 !important;
      cursor: not-allowed;
    }
    .dark .readonly {
      background: #374151 !important;
    }
    .loading {
      opacity: 0.6;
    }
    .week-tab {
      transition: all 0.2s;
    }
    .week-tab.active {
      background: #3b82f6;
      color: white;
    }
    .week-tab:not(.active):hover {
      background: #e5e7eb;
    }
    .dark .week-tab:not(.active):hover {
      background: #374151;
    }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">Viikon Ruokalista</h1>
        <p class="text-gray-600 dark:text-gray-400">Arkip√§iv√§t ‚Ä¢ <span id="updateStatus">Ladataan tietoja...</span></p>
      </div>

      <!-- Viikkovalitsin -->
      <div class="mb-6">
        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
          <h3 class="font-semibold mb-3 text-center">Valitse viikko:</h3>
          <div id="weekTabs" class="flex flex-wrap justify-center gap-2"></div>
          <div class="mt-3 text-center">
            <span class="text-sm text-gray-500 dark:text-gray-400">
              Nykyinen viikko: <span id="currentWeekInfo"></span>
            </span>
          </div>
        </div>
      </div>

      <div class="space-y-6" id="ruokaviikko"></div>
      
      <div class="mt-8 text-center space-y-4">
        <div class="flex flex-wrap justify-center gap-3">
          <button id="paivita" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">üîÑ P√§ivit√§ tiedot</button>
          <button id="kopioi" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">üìã Kopioi sis√§lt√∂</button>
          <button id="tyhjenna" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">üóëÔ∏è Tyhjenn√§ kaikki</button>
          <button id="tulosta" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">üñ®Ô∏è Tulosta</button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          üí° Tiedot p√§ivittyv√§t automaattisesti Google Sheetsist√§. Luo uusi v√§lilehti Sheetsiin uutta viikkoa varten.
        </p>
      </div>
    </div>
  </div>

  <script type="module">
    // ============ KONFIGURAATIO - VAIHDA T√ÑM√Ñ OMAAN SHEETS-LINKKIISI ============
    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit#gid=0';
    // ========================================================================

    // Globaalit muuttujat
    let currentWeek = null;
    let availableWeeks = [];
    let spreadsheetId = null;

    // Tumma tila automaattisesti
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
      document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    // P√§ivien ja kenttien m√§√§rittely
    const days = [
      { name: "Maanantai" },
      { name: "Tiistai" },
      { name: "Keskiviikko" },
      { name: "Torstai" },
      { name: "Perjantai" }
    ];
    
    const fields = [
      { key: "ruoka", label: "Ruoka", placeholder: "Ladataan..." },
      { key: "kuka", label: "Kuka tekee", placeholder: "Ladataan..." },
      { key: "tarvikkeet", label: "Tarvikkeet", placeholder: "Ladataan..." },
      { key: "ohjeet", label: "Ohjeet", placeholder: "Ladataan..." }
    ];

    // Render√∂i kent√§t
    function renderDays() {
      let html = "";
      days.forEach((day, dayIndex) => {
        html += `<div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
          <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">${day.name}</h2>
          <div class="grid md:grid-cols-2 gap-6">`;
        
        fields.slice(0,2).forEach((field) => {
          html += `<div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${field.label}</label>
            <div class="editable readonly text-base" 
                 data-day="${dayIndex}" 
                 data-field="${field.key}"
                 data-placeholder="${field.placeholder}"></div>
          </div>`;
        });
        
        html += `</div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${fields[2].label}</label>
            <div class="editable readonly text-base" 
                 data-day="${dayIndex}" 
                 data-field="${fields[2].key}"
                 data-placeholder="${fields[2].placeholder}"></div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${fields[3].label}</label>
            <div class="editable readonly text-base min-h-20" 
                 data-day="${dayIndex}" 
                 data-field="${fields[3].key}"
                 data-placeholder="${fields[3].placeholder}"></div>
          </div>
        </div>`;
      });
      document.getElementById('ruokaviikko').innerHTML = html;
    }

    // Poimi Spreadsheet ID URL:sta
    function extractSpreadsheetId(url) {
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }

    // Laske viikkonumero
    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
      const week1 = new Date(d.getFullYear(), 0, 4);
      return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }

    // Hae nykyinen viikko
    function getCurrentWeek() {
      const now = new Date();
      const year = now.getFullYear();
      const week = getWeekNumber(now);
      return `${year}-V${week.toString().padStart(2, '0')}`;
    }

    // Yksinkertainen CSV-parseri
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      return lines.map(line => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim().replace(/^"|"$/g, ''));
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim().replace(/^"|"$/g, ''));
        return result;
      });
    }

    // Hae saatavilla olevat v√§lilehdet
    async function getAvailableSheets() {
      try {
        // Hae v√§lilehtien tiedot Sheets API:sta (julkinen)
        const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`;
        const response = await fetch(sheetsUrl);
        
        if (response.ok) {
          const data = await response.json();
          return data.sheets.map(sheet => ({
            name: sheet.properties.title,
            gid: sheet.properties.sheetId
          }));
        }
      } catch (error) {
        console.log('API ei toimi, k√§ytet√§√§n oletusviikkoja');
      }
      
      // Fallback: luo viikoita nykyhetkest√§ eteenp√§in
      const weeks = [];
      const currentWeekNum = getCurrentWeek();
      const now = new Date();
      
      // Lis√§√§ 4 viikkoa taaksep√§in ja 8 viikkoa eteenp√§in
      for (let i = -4; i <= 8; i++) {
        const weekDate = new Date(now.getTime() + (i * 7 * 24 * 60 * 60 * 1000));
        const year = weekDate.getFullYear();
        const week = getWeekNumber(weekDate);
        const weekName = `${year}-V${week.toString().padStart(2, '0')}`;
        weeks.push({
          name: weekName,
          gid: 0 // K√§yt√§ aina ensimm√§ist√§ v√§lilehte√§ fallbackissa
        });
      }
      
      return weeks;
    }

    // Render√∂i viikkovalitsin
    function renderWeekTabs() {
      const tabsContainer = document.getElementById('weekTabs');
      const currentWeekInfo = document.getElementById('currentWeekInfo');
      
      // J√§rjest√§ viikot
      const sortedWeeks = availableWeeks.sort((a, b) => {
        // Yrit√§ j√§rjest√§√§ viikkojen mukaan jos mahdollista
        const aMatch = a.name.match(/(\d{4})-V(\d{2})/);
        const bMatch = b.name.match(/(\d{4})-V(\d{2})/);
        
        if (aMatch && bMatch) {
          const aYear = parseInt(aMatch[1]);
          const bYear = parseInt(bMatch[1]);
          const aWeek = parseInt(aMatch[2]);
          const bWeek = parseInt(bMatch[2]);
          
          if (aYear !== bYear) return aYear - bYear;
          return aWeek - bWeek;
        }
        
        return a.name.localeCompare(b.name);
      });

      let tabsHtml = '';
      sortedWeeks.forEach(week => {
        const isActive = week.name === currentWeek || (currentWeek === null && week.name === getCurrentWeek());
        const activeClass = isActive ? 'active' : '';
        
        tabsHtml += `
          <button class="week-tab ${activeClass} px-4 py-2 rounded-lg text-sm font-medium transition-colors" 
                  data-week="${week.name}" 
                  data-gid="${week.gid}">
            ${week.name}
          </button>
        `;
      });
      
      tabsContainer.innerHTML = tabsHtml;
      currentWeekInfo.textContent = getCurrentWeek();

      // Aseta nykyinen viikko jos ei ole asetettu
      if (!currentWeek) {
        const currentWeekObj = sortedWeeks.find(w => w.name === getCurrentWeek());
        if (currentWeekObj) {
          currentWeek = currentWeekObj.name;
        } else {
          currentWeek = sortedWeeks[sortedWeeks.length - 1]?.name || null;
        }
      }

      // Lis√§√§ click-eventit
      document.querySelectorAll('.week-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const weekName = this.getAttribute('data-week');
          selectWeek(weekName);
        });
      });
    }

    // Valitse viikko
    function selectWeek(weekName) {
      currentWeek = weekName;
      
      // P√§ivit√§ aktiivinen v√§lilehti
      document.querySelectorAll('.week-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-week') === weekName) {
          tab.classList.add('active');
        }
      });
      
      // Lataa valitun viikon tiedot
      loadData();
      
      // Tallenna valinta
      localStorage.setItem('selectedWeek', weekName);
    }

    // P√§ivit√§ yksitt√§inen kentt√§
    function updateField(dayIndex, fieldKey, value) {
      const element = document.querySelector(`[data-day="${dayIndex}"][data-field="${fieldKey}"]`);
      if (element) {
        element.textContent = value || '';
      }
    }

    // T√§yt√§ kent√§t Sheets-datalla
    function populateFields(sheetData) {
      // Tyhjenn√§ ensin kaikki kent√§t
      document.querySelectorAll('.editable').forEach(el => {
        el.textContent = '';
      });

      // Oletetaan ett√§ data on muodossa:
      // Rivi 0: [P√§iv√§, Ruoka, Kuka, Tarvikkeet, Ohjeet] (otsikot - ohitetaan)
      // Rivi 1: [Maanantai, Spagetti, √Ñiti, Pasta;Jauheliha, Keit√§ pasta...]
      // jne.
      
      sheetData.forEach((row, rowIndex) => {
        if (rowIndex === 0) return; // Ohita otsikkorivi
        
        const dayIndex = rowIndex - 1;
        if (dayIndex >= 5) return; // Vain 5 p√§iv√§√§
        
        const [dayName, ruoka, kuka, tarvikkeet, ohjeet] = row;
        
        // P√§ivit√§ kent√§t
        updateField(dayIndex, 'ruoka', ruoka);
        updateField(dayIndex, 'kuka', kuka);
        updateField(dayIndex, 'tarvikkeet', tarvikkeet);
        updateField(dayIndex, 'ohjeet', ohjeet);
      });
    }

    // Lataa tiedot Google Sheetsist√§
    async function loadData() {
      if (!currentWeek) return;
      
      const statusEl = document.getElementById('updateStatus');
      const container = document.getElementById('ruokaviikko');
      
      statusEl.textContent = 'Ladataan tietoja...';
      statusEl.className = 'text-blue-500';
      container.classList.add('loading');

      try {
        // Etsi valittu viikko
        const selectedWeek = availableWeeks.find(w => w.name === currentWeek);
        const gid = selectedWeek ? selectedWeek.gid : 0;

        // K√§yt√§ CSV-exporttia valitulla v√§lilehdell√§
        const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
        
        const response = await fetch(csvUrl);
        
        if (!response.ok) {
          throw new Error(`Dokumentti ei ole julkinen tai v√§lilehte√§ ei l√∂ydy (${response.status})`);
        }
        
        const csvData = await response.text();
        const rows = parseCSV(csvData);
        
        if (rows.length > 0) {
          populateFields(rows);
          const now = new Date().toLocaleTimeString('fi-FI');
          statusEl.textContent = `${currentWeek} - P√§ivitetty ${now}`;
          statusEl.className = 'text-green-500';
        } else {
          statusEl.textContent = `${currentWeek} - Ei dataa l√∂ytynyt`;
          statusEl.className = 'text-orange-500';
        }
      } catch (error) {
        console.error('Virhe ladattaessa dataa:', error);
        statusEl.textContent = `${currentWeek} - Virhe: ${error.message}`;
        statusEl.className = 'text-red-500';
      } finally {
        container.classList.remove('loading');
      }
    }

    // Alusta sovellus
    async function initApp() {
      spreadsheetId = extractSpreadsheetId(GOOGLE_SHEETS_URL);
      if (!spreadsheetId) {
        document.getElementById('updateStatus').textContent = 'Virheellinen Google Sheets URL';
        document.getElementById('updateStatus').className = 'text-red-500';
        return;
      }

      renderDays();
      
      // Hae saatavilla olevat v√§lilehdet
      availableWeeks = await getAvailableSheets();
      
      // Lataa tallennettu viikkovalinta
      const savedWeek = localStorage.getItem('selectedWeek');
      if (savedWeek && availableWeeks.some(w => w.name === savedWeek)) {
        currentWeek = savedWeek;
      } else {
        currentWeek = getCurrentWeek();
        // Jos nykyist√§ viikkoa ei l√∂ydy, k√§yt√§ viimeisint√§
        if (!availableWeeks.some(w => w.name === currentWeek)) {
          currentWeek = availableWeeks[availableWeeks.length - 1]?.name || null;
        }
      }
      
      renderWeekTabs();
      loadData();
      
      // Automaattinen p√§ivitys 5 minuutin v√§lein
      setInterval(loadData, 5 * 60 * 1000);
    }

    // Event listeners
    document.getElementById('paivita').addEventListener('click', loadData);

    // Kopioi
    document.getElementById('kopioi').onclick = function() {
      let output = `VIIKON RUOKALISTA - ${currentWeek}\n\n`;
      const dayBlocks = document.querySelectorAll('.bg-gray-50, .dark\\:bg-gray-800');
      Array.from(dayBlocks).forEach((block) => {
        const day = block.querySelector('h2').textContent;
        const [ruoka, kuka, tarvikkeet, ohjeet] = block.querySelectorAll('.editable');
        output += `${day.toUpperCase()}\nRuoka: ${ruoka.textContent.trim()}\nKuka tekee: ${kuka.textContent.trim()}\nTarvikkeet: ${tarvikkeet.textContent.trim()}\nOhjeet: ${ohjeet.textContent.trim()}\n\n`;
      });
      navigator.clipboard.writeText(output).then(() => {
        showToast('Ruokalista kopioitu leikep√∂yd√§lle!');
      });
    };

    // Tyhjenn√§ kaikki
    document.getElementById('tyhjenna').onclick = function() {
      if (!confirm('Haluatko varmasti tyhjent√§√§ n√§yt√∂n? (T√§m√§ ei muuta Google Sheetsi√§)')) return;
      document.querySelectorAll('.editable').forEach(el => {
        el.textContent = '';
      });
      document.getElementById('updateStatus').textContent = 'N√§ytt√∂ tyhjennetty';
      document.getElementById('updateStatus').className = 'text-gray-500';
      showToast('N√§ytt√∂ tyhjennetty!');
    };

    // Tulosta
    document.getElementById('tulosta').onclick = function() {
      window.print();
    };

    // Toast
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { 
        toast.style.transform = 'translateX(400px)'; 
        setTimeout(() => toast.remove(), 300); 
      }, 2000);
    }

    // K√§ynnist√§ sovellus
    initApp();
  </script>
</body>
</html>
