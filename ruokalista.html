<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Viikon Ruokalista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif }
    .editable {
      min-height: 40px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.2s;
      white-space: pre-line;
    }
    .dark .editable {
      border-color: #374151;
      background: #1f2937;
      color: #f3f4f6;
    }
    .readonly {
      background: #f3f4f6 !important;
      cursor: not-allowed;
    }
    .dark .readonly {
      background: #374151 !important;
    }
    .loading {
      opacity: 0.6;
    }
    select {
      background: inherit;
      color: inherit;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
    }
    .dark select {
      background: #1f2937;
      color: #f3f4f6;
      border-color: #374151;
    }
    option { color: #111; }
    .dark option { color: #fafafa; }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">Viikon Ruokalista</h1>
        <p class="text-gray-600 dark:text-gray-400">
          Arkip√§iv√§t ‚Ä¢ <span id="updateStatus">Ladataan tietoja...</span>
        </p>
      </div>

      <!-- Viikkovalitsin (DROPDOWN) -->
      <div class="mb-6">
        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
          <h3 class="font-semibold mb-3 text-center">Valitse viikko:</h3>
          <div class="flex justify-center">
            <select id="weekDropdown"></select>
          </div>
          <div class="mt-3 text-center">
            <span class="text-sm text-gray-500 dark:text-gray-400">
              Luo uusi v√§lilehti Sheetsiin muodossa 2025-V32 jne.
            </span>
          </div>
        </div>
      </div>

      <div class="space-y-6" id="ruokaviikko"></div>
      
      <div class="mt-8 text-center space-y-4">
        <div class="flex flex-wrap justify-center gap-3">
          <button id="paivita" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üîÑ P√§ivit√§ tiedot</button>
          <button id="kopioi" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üìã Kopioi sis√§lt√∂</button>
          <button id="tulosta" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üñ®Ô∏è Tulosta</button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          üí° Tiedot p√§ivittyv√§t automaattisesti Google Sheetsist√§. Luo uusi v√§lilehti Sheetsiin uutta viikkoa varten.
        </p>
      </div>
    </div>
  </div>

  <script type="module">
    // ============ MUUTA N√ÑM√Ñ OMAAN K√ÑYTT√ñ√ñSI ============
    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/10bBmmXNo8YWJKgak6MT1znba_dE1Ft-eyAfM-qNjqqU/edit?gid=0#gid=0';
    const START_WEEK = '2025-V32'; // Aloitusviikko
    const WEEK_COUNT = 20; // Kuinka monta viikkoa n√§ytet√§√§n valitsimessa
    // =====================================================

    // Tumma tila automaattisesti
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
      document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    // P√§ivien ja kenttien m√§√§rittely
    const days = [
      { name: "Maanantai" },
      { name: "Tiistai" },
      { name: "Keskiviikko" },
      { name: "Torstai" },
      { name: "Perjantai" }
    ];
    const fields = [
      { key: "ruoka", label: "Ruoka", placeholder: "Ladataan..." },
      { key: "kuka", label: "Kuka tekee", placeholder: "Ladataan..." },
      { key: "tarvikkeet", label: "Tarvikkeet", placeholder: "Ladataan..." },
      { key: "ohjeet", label: "Ohjeet", placeholder: "Ladataan..." }
    ];

    // Globaalit muuttujat
    let currentWeek = START_WEEK;
    let spreadsheetId = null;
    let availableWeeks = [];

    // Luo viikkolista muodossa [{name, sheetName}]
    function generateWeekList(startWeek, count) {
      const weeks = [];
      const [year, weekStr] = startWeek.split('-V');
      let currentYear = parseInt(year, 10);
      let currentWeekNum = parseInt(weekStr, 10);

      for (let i = 0; i < count; i++) {
        weeks.push({
          name: `${currentYear}-V${currentWeekNum.toString().padStart(2, '0')}`,
          sheetName: `${currentYear}-V${currentWeekNum.toString().padStart(2, '0')}`
        });
        currentWeekNum++;
        if (currentWeekNum > 52) {
          currentWeekNum = 1;
          currentYear++;
        }
      }
      return weeks;
    }

    // Poimi Spreadsheet ID URL:sta
    function extractSpreadsheetId(url) {
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }

    // Render√∂i viikonp√§iv√§t ja kent√§t
    function renderDays() {
      let html = "";
      days.forEach((day, dayIndex) => {
        html += `<div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
          <h2 class="text-2xl font-semibold mb-4">${day.name}</h2>
          <div class="grid md:grid-cols-2 gap-6">`;
        fields.slice(0,2).forEach((field) => {
          html += `<div>
            <label class="block text-sm font-medium mb-2">${field.label}</label>
            <div class="editable readonly text-base" data-day="${dayIndex}" data-field="${field.key}" data-placeholder="${field.placeholder}"></div>
          </div>`;
        });
        html += `</div>
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">${fields[2].label}</label>
            <div class="editable readonly text-base" data-day="${dayIndex}" data-field="${fields[2].key}" data-placeholder="${fields[2].placeholder}"></div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">${fields[3].label}</label>
            <div class="editable readonly text-base min-h-20" data-day="${dayIndex}" data-field="${fields[3].key}" data-placeholder="${fields[3].placeholder}"></div>
          </div>
        </div>`;
      });
      document.getElementById('ruokaviikko').innerHTML = html;
    }

    // Render√∂i viikkovalitsin DROPDOWN
    function renderWeekDropdown() {
      const dropdown = document.getElementById('weekDropdown');
      dropdown.innerHTML = '';
      availableWeeks.forEach(week => {
        const opt = document.createElement('option');
        opt.value = week.name;
        opt.textContent = week.name;
        if (week.name === currentWeek) opt.selected = true;
        dropdown.appendChild(opt);
      });
      dropdown.onchange = function() {
        selectWeek(this.value);
      };
    }

    // Valitse viikko
    function selectWeek(weekName) {
      currentWeek = weekName;
      loadData();
      localStorage.setItem('selectedWeek', weekName);
    }

    // Yksinkertainen CSV-parseri
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      return lines.map(line => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            if (i + 1 < line.length && line[i + 1] === '"') {
              current += '"';
              i++; // skip next quote
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim().replace(/^"|"$/g, ''));
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim().replace(/^"|"$/g, ''));
        return result;
      });
    }

    // Muuta rivinvaihdot HTML-muotoon
    function formatLinebreaks(text) {
      if (!text) return '';
      // Muuta \r\n ja \r -> \n
      return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').map(line => {
        // Jos tyhj√§ rivi, s√§ilyt√§
        if(line === '') return '<br>';
        return line.replace(/</g, "&lt;").replace(/>/g, "&gt;"); // XSS-suojaus
      }).join('<br>');
    }

    // P√§ivit√§ yksitt√§inen kentt√§
    function updateField(dayIndex, fieldKey, value) {
      const element = document.querySelector(`[data-day="${dayIndex}"][data-field="${fieldKey}"]`);
      if (element) {
        element.innerHTML = formatLinebreaks(value || '');
      }
    }

    // T√§yt√§ kent√§t Sheets-datalla
    function populateFields(sheetData) {
      document.querySelectorAll('.editable').forEach(el => { el.innerHTML = ''; });
      sheetData.forEach((row, rowIndex) => {
        if (rowIndex === 0) return; // Ohita otsikkorivi
        const dayIndex = rowIndex - 1;
        if (dayIndex >= 5) return;
        const [_, ruoka, kuka, tarvikkeet, ohjeet] = row;
        updateField(dayIndex, 'ruoka', ruoka);
        updateField(dayIndex, 'kuka', kuka);
        updateField(dayIndex, 'tarvikkeet', tarvikkeet);
        updateField(dayIndex, 'ohjeet', ohjeet);
      });
    }

    // Lataa tiedot Google Sheetsist√§
    async function loadData() {
      if (!currentWeek) return;
      const statusEl = document.getElementById('updateStatus');
      const container = document.getElementById('ruokaviikko');
      statusEl.textContent = 'Ladataan tietoja...';
      container.classList.add('loading');
      try {
        const sheetName = currentWeek;
        const encodedSheetName = encodeURIComponent(sheetName);
        const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodedSheetName}`;
        const response = await fetch(csvUrl);
        if (!response.ok) throw new Error(`Viikkoa "${sheetName}" ei l√∂ydy tai dokumentti ei ole julkinen`);
        const csvData = await response.text();
        if (csvData.includes('Invalid') || csvData.includes('Error')) throw new Error(`Viikkoa "${sheetName}" ei l√∂ydy`);
        const rows = parseCSV(csvData);
        if (rows.length > 0) {
          populateFields(rows);
          const now = new Date();
          const formatted = ('0'+now.getDate()).slice(-2) + '.' +
                            ('0'+(now.getMonth()+1)).slice(-2) + '.' +
                            now.getFullYear() + ' ' +
                            ('0'+now.getHours()).slice(-2) + '.' +
                            ('0'+now.getMinutes()).slice(-2);
          statusEl.textContent = `${currentWeek} ‚Äì P√§ivitetty ${formatted}`;
        } else {
          statusEl.textContent = `${currentWeek} ‚Äì Ei dataa`;
        }
      } catch (error) {
        statusEl.textContent = `Virhe (${currentWeek}): ${error.message}`;
        document.querySelectorAll('.editable').forEach(el => { el.innerHTML = ''; });
      } finally {
        container.classList.remove('loading');
      }
    }

    // Kopioi ruokalista leikep√∂yd√§lle
    document.getElementById('kopioi').onclick = function() {
      let output = `VIIKON RUOKALISTA - ${currentWeek}\n\n`;
      const dayBlocks = document.querySelectorAll('.bg-gray-50, .dark\\:bg-gray-800');
      Array.from(dayBlocks).forEach((block) => {
        const day = block.querySelector('h2').textContent;
        const [ruoka, kuka, tarvikkeet, ohjeet] = block.querySelectorAll('.editable');
        // Poistetaan <br> kopioitaessa
        output += `${day.toUpperCase()}\nRuoka: ${ruoka.innerText.trim()}\nKuka tekee: ${kuka.innerText.trim()}\nTarvikkeet: ${tarvikkeet.innerText.trim()}\nOhjeet: ${ohjeet.innerText.trim()}\n\n`;
      });
      navigator.clipboard.writeText(output).then(() => {
        showToast('Ruokalista kopioitu leikep√∂yd√§lle!');
      });
    };

    // Tulosta
    document.getElementById('tulosta').onclick = function() { window.print(); };

    // Toast-ilmoitus
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { 
        toast.style.transform = 'translateX(400px)'; 
        setTimeout(() => toast.remove(), 300); 
      }, 2000);
    }

    // P√§ivit√§-nappi
    document.getElementById('paivita').addEventListener('click', loadData);

    // Alusta sovellus
    function initApp() {
      spreadsheetId = extractSpreadsheetId(GOOGLE_SHEETS_URL);
      if (!spreadsheetId) {
        document.getElementById('updateStatus').textContent = 'Virheellinen Google Sheets URL';
        return;
      }
      renderDays();
      availableWeeks = generateWeekList(START_WEEK, WEEK_COUNT);
      // Lataa tallennettu viikkovalinta tai k√§yt√§ aloitusviikkoa
      const savedWeek = localStorage.getItem('selectedWeek');
      if (savedWeek && availableWeeks.some(w => w.name === savedWeek)) {
        currentWeek = savedWeek;
      } else {
        currentWeek = availableWeeks[0]?.name || START_WEEK;
      }
      renderWeekDropdown();
      loadData();
      setInterval(loadData, 5 * 60 * 1000);
    }

    // K√§ynnist√§ sovellus
    initApp();
  </script>
</body>
</html>
