<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Viikon Ruokalista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif }
    .editable {
      min-height: 40px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      white-space: pre-line;
      transition: all 0.2s;
    }
    .dark .editable {
      border-color: #374151;
      background: #1f2937;
      color: #f3f4f6;
    }
    .loading { opacity: 0.6; }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">Viikon Ruokalista</h1>
        <p class="text-gray-600 dark:text-gray-400">Arkip√§iv√§t ‚Ä¢ <span id="updateStatus">Ladataan tietoja...</span></p>
      </div>
      <div id="ruokaviikko" class="space-y-6"></div>
      <div class="mt-8 text-center space-y-4">
        <div class="flex flex-wrap justify-center gap-3">
          <button id="paivita" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">üîÑ P√§ivit√§ tiedot</button>
          <button id="kopioi" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">üìã Kopioi sis√§lt√∂</button>
          <button id="tulosta" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">üñ®Ô∏è Tulosta</button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          üí° Tiedot p√§ivittyv√§t automaattisesti Google Sheetsist√§. Klikkaa "P√§ivit√§ tiedot" saadaksesi uusimmat tiedot.
        </p>
      </div>
    </div>
  </div>
  <script type="module">
    // VAIHDA OMAAN SHEETS-URLIISI!
    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/10bBmmXNo8YWJKgak6MT1znba_dE1Ft-eyAfM-qNjqqU/edit?usp=sharing';

    // Tumma tila automaattisesti
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
      document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    // P√§ivien nimet
    const days = ["Maanantai", "Tiistai", "Keskiviikko", "Torstai", "Perjantai"];
    // Kenttien nimet ja otsikot
    const fields = [
      { key: "ruoka", label: "Ruoka" },
      { key: "kuka", label: "Kokki" },
      { key: "tarvikkeet", label: "Tarvikkeet" },
      { key: "ohjeet", label: "Ohjeet" }
    ];

    // Render√∂i tyhj√§t kent√§t
    function renderDays(rows=[]) {
      let html = "";
      for(let i=0; i<days.length; i++) {
        html += `<div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
          <h2 class="text-2xl font-semibold mb-4">${days[i]}</h2>
          <div class="grid md:grid-cols-2 gap-6">`;
        fields.slice(0,2).forEach((field, j) => {
          html += `<div>
            <label class="block text-sm font-medium mb-2">${field.label}</label>
            <div class="editable readonly text-base" id="d${i}-${field.key}"></div>
          </div>`;
        });
        html += `</div>
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">${fields[2].label}</label>
            <div class="editable readonly text-base" id="d${i}-${fields[2].key}"></div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">${fields[3].label}</label>
            <div class="editable readonly text-base min-h-20" id="d${i}-${fields[3].key}"></div>
          </div>
        </div>`;
      }
      document.getElementById('ruokaviikko').innerHTML = html;
    }

    // P√§ivit√§ kentt√§ (HTML: rivinvaihdot n√§kyviin)
    function updateField(dayIndex, fieldKey, value) {
      const el = document.getElementById(`d${dayIndex}-${fieldKey}`);
      if (el) {
        el.innerHTML = (value || '').replace(/\n/g, "<br>");
      }
    }

    // T√§yt√§ tiedot taulukosta
    function populateFields(sheetData) {
      for(let i=0; i<days.length; i++) {
        const row = sheetData[i+1]; // rivi 0 = otsikot
        if (!row) continue;
        updateField(i, "ruoka", row[1]);
        updateField(i, "kuka", row[2]);
        updateField(i, "tarvikkeet", row[3]);
        updateField(i, "ohjeet", row[4]);
      }
    }

    // Lataa tiedot Google Sheetsist√§
    async function loadData() {
      const statusEl = document.getElementById('updateStatus');
      const container = document.getElementById('ruokaviikko');
      statusEl.textContent = 'Ladataan tietoja...';
      statusEl.className = 'text-blue-500';
      container.classList.add('loading');
      try {
        const spreadsheetId = (GOOGLE_SHEETS_URL.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/) || [])[1];
        if (!spreadsheetId)
          throw new Error('Virheellinen Google Sheets URL');
        const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=0`;
        const response = await fetch(csvUrl);
        if (!response.ok)
          throw new Error(`Dokumentti ei ole julkinen tai sit√§ ei l√∂ydy (${response.status})`);
        const csvData = await response.text();
        const rows = Papa.parse(csvData, { skipEmptyLines: true }).data;
        if (rows.length > 1) {
          renderDays(rows);
          populateFields(rows);
          const now = new Date().toLocaleTimeString('fi-FI');
          statusEl.textContent = `P√§ivitetty ${now}`;
          statusEl.className = 'text-gray-500';
        } else {
          statusEl.textContent = 'Ei dataa l√∂ytynyt';
          statusEl.className = 'text-orange-500';
        }
      } catch (error) {
        statusEl.textContent = `Virhe: ${error.message}`;
        statusEl.className = 'text-red-500';
      } finally {
        container.classList.remove('loading');
      }
    }

    // Kopioi
    document.getElementById('kopioi').onclick = function() {
      let output = 'VIIKON RUOKALISTA\n\n';
      for(let i=0; i<days.length; i++) {
        output += `${days[i].toUpperCase()}\n`;
        fields.forEach(f => {
          const el = document.getElementById(`d${i}-${f.key}`);
          let txt = el ? el.innerText : '';
          output += `${f.label}: ${txt}\n`;
        });
        output += `\n`;
      }
      navigator.clipboard.writeText(output).then(() => {
        showToast('Ruokalista kopioitu leikep√∂yd√§lle!');
      });
    };

    // Tulosta
    document.getElementById('tulosta').onclick = function() {
      window.print();
    };

    // P√§ivit√§ napista
    document.getElementById('paivita').onclick = loadData;

    // Toast info
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { 
        toast.style.transform = 'translateX(400px)'; 
        setTimeout(() => toast.remove(), 300); 
      }, 2000);
    }

    // Alusta ja lataa heti
    renderDays();
    loadData();
    setInterval(loadData, 5 * 60 * 1000); // 5min

  </script>
</body>
</html>
