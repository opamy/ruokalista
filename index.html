<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Viikon Ruokalista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif }
    .editable {
      min-height: 40px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.2s;
    }
    .dark .editable {
      border-color: #374151;
      background: #1f2937;
      color: #f3f4f6;
    }
    .editable:focus {
      outline: none;
      border-color: #5D5CDE;
      background: white;
      box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
    }
    .dark .editable:focus {
      background: #111827;
    }
    .editable:empty:before {
      content: attr(data-placeholder);
      color: #9ca3af;
    }
    .dark .editable:empty:before {
      color: #6b7280;
    }
    .readonly {
      background: #f3f4f6 !important;
      cursor: not-allowed;
    }
    .dark .readonly {
      background: #374151 !important;
    }
    .loading {
      opacity: 0.6;
    }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">Viikon Ruokalista</h1>
        <p class="text-gray-600 dark:text-gray-400">Arkip√§iv√§t ‚Ä¢ <span id="updateStatus">Ladataan tietoja...</span></p>
      </div>

      <div class="space-y-6" id="ruokaviikko"></div>
      
      <div class="mt-8 text-center space-y-4">
        <div class="flex flex-wrap justify-center gap-3">
          <button id="paivita" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üîÑ P√§ivit√§ tiedot</button>
          <button id="kopioi" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üìã Kopioi sis√§lt√∂</button>
          <button id="tulosta" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">üñ®Ô∏è Tulosta</button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          üí° Tiedot p√§ivittyv√§t automaattisesti Google Sheetsist√§. Klikkaa "P√§ivit√§ tiedot" saadaksesi uusimmat tiedot.
        </p>
      </div>
    </div>
  </div>

  <script type="module">
    // ============ KONFIGURAATIO - VAIHDA T√ÑM√Ñ OMAAN SHEETS-LINKKIISI ============
    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuJ42x7lep6sVX5NmlCWwghH-chQv9hDWZ6TVOTKLtcFrDxxSSr0TSN5GPKz6q5m9tkNxCzPi5NAzo/pub?gid=0&single=true&output=csv';
    // ========================================================================

    // Tumma tila automaattisesti
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
      document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    // P√§ivien ja kenttien m√§√§rittely
    const days = [
      { name: "Maanantai" },
      { name: "Tiistai" },
      { name: "Keskiviikko" },
      { name: "Torstai" },
      { name: "Perjantai" }
    ];
    
    const fields = [
      { key: "ruoka", label: "Ruoka", placeholder: "Ladataan..." },
      { key: "kuka", label: "Kuka tekee", placeholder: "Ladataan..." },
      { key: "tarvikkeet", label: "Tarvikkeet", placeholder: "Ladataan..." },
      { key: "ohjeet", label: "Ohjeet", placeholder: "Ladataan..." }
    ];

    // Render√∂i kent√§t
    function renderDays() {
      let html = "";
      days.forEach((day, dayIndex) => {
        html += `<div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
          <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">${day.name}</h2>
          <div class="grid md:grid-cols-2 gap-6">`;
        
        fields.slice(0,2).forEach((field) => {
          html += `<div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${field.label}</label>
            <div class="editable readonly text-base" 
                 data-day="${dayIndex}" 
                 data-field="${field.key}"
                 data-placeholder="${field.placeholder}"></div>
          </div>`;
        });
        
        html += `</div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${fields[2].label}</label>
            <div class="editable readonly text-base" 
                 data-day="${dayIndex}" 
                 data-field="${fields[2].key}"
                 data-placeholder="${fields[2].placeholder}"></div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${fields[3].label}</label>
            <div class="editable readonly text-base min-h-20" 
                 data-day="${dayIndex}" 
                 data-field="${fields[3].key}"
                 data-placeholder="${fields[3].placeholder}"></div>
          </div>
        </div>`;
      });
      document.getElementById('ruokaviikko').innerHTML = html;
    }

    // Poimi Spreadsheet ID URL:sta
    function extractSpreadsheetId(url) {
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }

    // Yksinkertainen CSV-parseri
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      return lines.map(line => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim().replace(/^"|"$/g, ''));
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim().replace(/^"|"$/g, ''));
        return result;
      });
    }

    // P√§ivit√§ yksitt√§inen kentt√§
    function updateField(dayIndex, fieldKey, value) {
      const element = document.querySelector(`[data-day="${dayIndex}"][data-field="${fieldKey}"]`);
      if (element) {
        element.textContent = value || '';
      }
    }

    // T√§yt√§ kent√§t Sheets-datalla
    function populateFields(sheetData) {
      // Tyhjenn√§ ensin kaikki kent√§t
      document.querySelectorAll('.editable').forEach(el => {
        el.textContent = '';
      });

      // Oletetaan ett√§ data on muodossa:
      // Rivi 0: [P√§iv√§, Ruoka, Kuka, Tarvikkeet, Ohjeet] (otsikot - ohitetaan)
      // Rivi 1: [Maanantai, Spagetti, √Ñiti, Pasta;Jauheliha, Keit√§ pasta...]
      // jne.
      
      sheetData.forEach((row, rowIndex) => {
        if (rowIndex === 0) return; // Ohita otsikkorivi
        
        const dayIndex = rowIndex - 1;
        if (dayIndex >= 5) return; // Vain 5 p√§iv√§√§
        
        const [dayName, ruoka, kuka, tarvikkeet, ohjeet] = row;
        
        // P√§ivit√§ kent√§t
        updateField(dayIndex, 'ruoka', ruoka);
        updateField(dayIndex, 'kuka', kuka);
        updateField(dayIndex, 'tarvikkeet', tarvikkeet);
        updateField(dayIndex, 'ohjeet', ohjeet);
      });
    }

    // Lataa tiedot Google Sheetsist√§
    async function loadData() {
      const statusEl = document.getElementById('updateStatus');
      const container = document.getElementById('ruokaviikko');
      
      statusEl.textContent = 'Ladataan tietoja...';
      statusEl.className = 'text-blue-500';
      container.classList.add('loading');

      try {
        const spreadsheetId = extractSpreadsheetId(GOOGLE_SHEETS_URL);
        if (!spreadsheetId) {
          throw new Error('Virheellinen Google Sheets URL');
        }

        // K√§yt√§ CSV-exporttia
        const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=0`;
        
        const response = await fetch(csvUrl);
        
        if (!response.ok) {
          throw new Error(`Dokumentti ei ole julkinen tai sit√§ ei l√∂ydy (${response.status})`);
        }
        
        const csvData = await response.text();
        const rows = parseCSV(csvData);
        
        if (rows.length > 0) {
          populateFields(rows);
          const now = new Date().toLocaleTimeString('fi-FI');
          statusEl.textContent = `P√§ivitetty ${now}`;
          statusEl.className = 'text-green-500';
        } else {
          statusEl.textContent = 'Ei dataa l√∂ytynyt';
          statusEl.className = 'text-orange-500';
        }
      } catch (error) {
        console.error('Virhe ladattaessa dataa:', error);
        statusEl.textContent = `Virhe: ${error.message}`;
        statusEl.className = 'text-red-500';
      } finally {
        container.classList.remove('loading');
      }
    }

    // Event listeners
    document.getElementById('paivita').addEventListener('click', loadData);

    // Kopioi
    document.getElementById('kopioi').onclick = function() {
      let output = 'VIIKON RUOKALISTA\n\n';
      const dayBlocks = document.querySelectorAll('.bg-gray-50, .dark\\:bg-gray-800');
      Array.from(dayBlocks).forEach((block) => {
        const day = block.querySelector('h2').textContent;
        const [ruoka, kuka, tarvikkeet, ohjeet] = block.querySelectorAll('.editable');
        output += `${day.toUpperCase()}\nRuoka: ${ruoka.textContent.trim()}\nKuka tekee: ${kuka.textContent.trim()}\nTarvikkeet: ${tarvikkeet.textContent.trim()}\nOhjeet: ${ohjeet.textContent.trim()}\n\n`;
      });
      navigator.clipboard.writeText(output).then(() => {
        showToast('Ruokalista kopioitu leikep√∂yd√§lle!');
      });
    };

    // Tulosta
    document.getElementById('tulosta').onclick = function() {
      window.print();
    };

    // Toast
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { 
        toast.style.transform = 'translateX(400px)'; 
        setTimeout(() => toast.remove(), 300); 
      }, 2000);
    }

    // Alusta sivu
    renderDays();
    
    // Lataa tiedot heti sivun latautuessa
    loadData();

    // P√§ivit√§ tiedot automaattisesti 5 minuutin v√§lein (valinnainen)
    setInterval(loadData, 5 * 60 * 1000); // 5 minuuttia
  </script>
</body>
</html>
